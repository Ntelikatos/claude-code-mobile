################################################################################
# Hardened OpenSSH Server Configuration
# Generated: 2026-02-09
# Standards: sshaudit.com 2025+ guidelines
# Security: Modern algorithms only, key-based auth, no root login
################################################################################

################################################################################
# Network Configuration
################################################################################

# Listen on standard SSH port
Port 22

# Support both IPv4 and IPv6
AddressFamily any
ListenAddress 0.0.0.0
ListenAddress ::

################################################################################
# Host Keys
################################################################################

# Ed25519 (primary) - Modern, secure, fast
HostKey /etc/ssh/ssh_host_ed25519_key

# RSA 4096 (fallback) - Legacy compatibility
HostKey /etc/ssh/ssh_host_rsa_key

################################################################################
# Cryptographic Algorithms (Modern Only)
################################################################################

# Key Exchange Algorithms
# curve25519: Modern ECDH, high security
# diffie-hellman-group16/18: Strong DH groups (4096/8192-bit)
KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group18-sha512,diffie-hellman-group16-sha512

# Ciphers
# ChaCha20-Poly1305: Fast authenticated encryption
# AES-GCM: Hardware-accelerated authenticated encryption
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com

# Message Authentication Codes
# ETM (Encrypt-Then-MAC) variants only for security
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com

# Host Key Algorithms
# Prefer Ed25519, allow modern RSA signatures
HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256

################################################################################
# Authentication
################################################################################

# Root login prohibited
PermitRootLogin no

# Public key authentication enabled
PubkeyAuthentication yes

# Password authentication disabled (keys only)
PasswordAuthentication no
ChallengeResponseAuthentication no
KbdInteractiveAuthentication no

# PAM disabled (not needed for key-only auth)
UsePAM no

# Require public key authentication
AuthenticationMethods publickey

# Limit failed authentication attempts
MaxAuthTries 3

# Time window for authentication (seconds)
LoginGraceTime 30

# Connection rate limiting (start:rate:full)
# Start dropping 50% of new connections after 3, reject all after 10
MaxStartups 3:50:10

################################################################################
# Session Management
################################################################################

# Keep-alive interval (seconds) - detects broken connections
ClientAliveInterval 300

# Keep-alive retries before disconnect
ClientAliveCountMax 2

################################################################################
# Feature Controls
################################################################################

# X11 forwarding disabled (security risk)
X11Forwarding no

# TCP forwarding allowed (for tunneling)
AllowTcpForwarding yes

# Agent forwarding allowed (for key chaining)
AllowAgentForwarding yes

# Tunnel device forwarding disabled
PermitTunnel no

# MOTD handled by system, not SSH
PrintMotd no

# Display custom banner before authentication
Banner /etc/ssh/banner.txt

################################################################################
# Logging
################################################################################

# Log facility for syslog/journald
SyslogFacility AUTH

# Verbose logging for fail2ban and security auditing
LogLevel VERBOSE

################################################################################
# Access Control
################################################################################

# Only allow the claude user to connect
AllowUsers claude

################################################################################
# Subsystems
################################################################################

# SFTP subsystem for secure file transfer
Subsystem sftp /usr/lib/openssh/sftp-server
